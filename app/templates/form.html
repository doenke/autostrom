{% extends "layout.html" %}
{% block content %}

{% if error_msg %}
  <div class="alert alert-error">
    <strong>Fehler beim Laden der Daten:</strong><br>
    <code>{{ error_msg }}</code>
  </div>
{% endif %}

{% if info_msg and not error_msg %}
  <div class="alert alert-info">
    {{ info_msg }}
  </div>
{% endif %}

<h2>Neue Ablesung</h2>
<p class="muted">
  {% if last %}
    Letzte Ablesung: <strong>{{ last.Datum }}</strong><br>
    Zählerstand: <strong>{{ last.Zaehlerstand }} kWh</strong> Strompreis:
    <strong>{{ '%.4f'|format((last.Strompreis|string).replace(',', '.')|float) }} €/kWh</strong>
  {% else %}
    Noch keine Daten vorhanden.
  {% endif %}
</p>

<form method="post" action="/submit" class="card form-new-reading">
  <!-- If you use CSRF protection, include the token here -->

  <label for="ablesedatum">Ablesedatum</label>
  <input
    type="date"
    id="ablesedatum"
    name="ablesedatum"
    value="{{ today_iso }}"
    required
  >

  <label for="zaehlerstand">Aktueller Zählerstand (kWh)</label>
  <input
    type="number"
    step="1"
    id="zaehlerstand"
    name="zaehlerstand"
    placeholder="z. B. 12345"
    required
  >

  <label for="strompreis_eur">Strompreis (€/kWh)</label>
  <input
    type="number"
    step="0.0001"
    id="strompreis_eur"
    name="strompreis_eur"
    value="{{ last_price }}"
    placeholder="z. B. 0.3200"
    required
  >

  {% if mail_available %}
    <label class="checkbox" for="send_mail">
      <input
        type="checkbox"
        id="send_mail"
        name="send_mail"
        {% if default_mail_checked %}checked{% endif %}
      >
      PDF per E-Mail senden
    </label>
  {% endif %}

  {% if paperless_available %}
    <label class="checkbox" for="upload_paperless">
      <input
        type="checkbox"
        id="upload_paperless"
        name="upload_paperless"
        {% if default_paperless_checked %}checked{% endif %}
      >
      PDF zu Paperless-ngx hochladen
    </label>
  {% endif %}

  <button type="submit">Abrechnung erstellen</button>
</form>

{% if rows and rows|length > 0 %}
  <section class="section-entries">
    <h2>Letzte Einträge</h2>

    <div class="table-wrapper">
      <table class="medplan">
        <thead>
          <tr>
            <th>Datum</th>
            <th>Zählerstand</th>
            <th>Verbrauch</th>
            <th>Strompreis</th>
            <th>Abrechnung</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rows %}
            <tr>
              <td>{{ r.Datum }}</td>
              <td>{{ r.Zaehlerstand }} kWh</td>
              <td>{{ r.Verbrauch }} kWh</td>
              <td>{{ '%.4f'|format((r.Strompreis|string).replace(',', '.')|float) }} €</td>
              <td>{{ '%.2f'|format((r.Abrechnung|string).replace(',', '.')|float) }} €</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if show_delete_button %}
      <form action="/delete-last" method="post" class="delete-form">
        <!-- If you use CSRF protection, include the token here -->
        <button
          type="submit"
          class="danger-button"
        >
          Letzte Zeile aus CSV löschen
        </button>
      </form>
    {% endif %}
  </section>
{% endif %}

{% endblock %}
