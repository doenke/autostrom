{% extends "layout.html" %}
{% block content %}

{% if form_values is not defined %}
  {% set form_values = {} %}
{% endif %}

{% if error_msg %}
  <div class="alert alert-error">
    <strong>Fehler beim Laden der Daten:</strong><br>
    <code>{{ error_msg }}</code>
  </div>
{% endif %}

{% if info_msg and not error_msg %}
  <div class="alert alert-info">
    {{ info_msg }}
  </div>
{% endif %}

<h2>Neue Ablesung</h2>
<p class="muted">
  {% if last %}
    Letzte Ablesung: <strong>{{ last.Datum }}</strong><br>
    Z√§hlerstand:
    <strong
      data-number="{{ ((last.Zaehlerstand|string)|replace(',', '.')) }}"
      data-decimals="0"
      data-suffix="kWh"
    >
      {{ last.Zaehlerstand }} kWh
    </strong>
    &nbsp;&middot;&nbsp;
    Strompreis:
    <strong
      data-number="{{ ((last.Strompreis|string)|replace(',', '.')|float) }}"
      data-decimals="4"
      data-suffix="‚Ç¨/kWh"
    >
      {{ '%.4f'|format((last.Strompreis|string).replace(',', '.')|float) }} ‚Ç¨/kWh
    </strong>
  {% else %}
    Noch keine Daten vorhanden.
  {% endif %}
</p>

<form method="post" action="/submit" class="card form-new-reading">
  <!-- If you use CSRF protection, include the token here -->

  <label for="ablesedatum_display">Ablesedatum</label>
  <input
    type="hidden"
    id="ablesedatum"
    name="ablesedatum"
    value="{{ form_values.ablesedatum or today_iso }}"
  >
  <input
    type="text"
    id="ablesedatum_display"
    class="date-display"
    placeholder="z. B. 24.06.2024"
    required
    inputmode="numeric"
    autocomplete="off"
  >

  <label for="zaehlerstand">Aktueller Z√§hlerstand (kWh)</label>
  <input
    type="number"
    step="1"
    id="zaehlerstand"
    name="zaehlerstand"
    placeholder="z. B. 12345"
    value="{{ form_values.zaehlerstand or '' }}"
    required
  >
  <small class="muted">
    Hinweis: Der Verbrauch zwischen zwei Ablesungen muss zwischen 10 und 2000 kWh liegen.
  </small>

  <label for="strompreis_eur">Strompreis (‚Ç¨/kWh)</label>
  <input
    type="number"
    step="0.0001"
    id="strompreis_eur"
    name="strompreis_eur"
    value="{{ form_values.strompreis_eur or last_price }}"
    placeholder="z. B. 0.3200"
    required
  >

  {% if mail_available %}
    <label class="checkbox" for="send_mail">
      <input
        type="checkbox"
        id="send_mail"
        name="send_mail"
        {% if default_mail_checked %}checked{% endif %}
      >
      PDF per E-Mail senden
    </label>
  {% endif %}

  {% if paperless_available %}
    <label class="checkbox" for="upload_paperless">
      <input
        type="checkbox"
        id="upload_paperless"
        name="upload_paperless"
        {% if default_paperless_checked %}checked{% endif %}
      >
      PDF zu Paperless-ngx hochladen
    </label>
  {% endif %}

  <button type="submit">Abrechnung erstellen</button>
</form>

{% if rows and rows|length > 0 %}
  <section class="section-entries">
    <h2>Letzte Eintr√§ge</h2>

    <div class="table-wrapper">
      <table class="medplan readings-table">
        <thead>
          <tr>
            <th>Datum</th>
            <th class="numeric">Z√§hlerstand</th>
            <th class="numeric">Verbrauch</th>
            <th class="numeric">Strompreis</th>
            <th class="numeric">Abrechnung</th>
            <th class="actions" scope="col">Aktion</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rows %}
            <tr>
              <td>{{ r.Datum }}</td>
              <td
                class="numeric"
                data-number="{{ ((r.Zaehlerstand|string)|replace(',', '.')) }}"
                data-decimals="0"
                data-suffix="kWh"
              >
                {{ r.Zaehlerstand }} kWh
              </td>
              <td
                class="numeric"
                data-number="{{ ((r.Verbrauch|string)|replace(',', '.')) }}"
                data-decimals="0"
                data-suffix="kWh"
              >
                {{ r.Verbrauch }} kWh
              </td>
              <td
                class="numeric"
                data-number="{{ ((r.Strompreis|string)|replace(',', '.')|float) }}"
                data-decimals="4"
                data-suffix="‚Ç¨/kWh"
              >
                {{ '%.4f'|format((r.Strompreis|string).replace(',', '.')|float) }} ‚Ç¨/kWh
              </td>
              <td
                class="numeric"
                data-number="{{ ((r.Abrechnung|string)|replace(',', '.')|float) }}"
                data-decimals="2"
                data-suffix="‚Ç¨"
              >
                {{ '%.2f'|format((r.Abrechnung|string).replace(',', '.')|float) }} ‚Ç¨
              </td>
              <td class="actions">
                {% if loop.first and show_delete_button %}
                  <form
                    action="/delete-last"
                    method="post"
                    class="delete-entry-form"
                    title="Letzte Zeile l√∂schen"
                  >
                    <button type="submit" class="icon-button" aria-label="Letzte Zeile l√∂schen">
                      <span aria-hidden="true">üóëÔ∏è</span>
                    </button>
                  </form>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
{% endif %}

{% endblock %}
