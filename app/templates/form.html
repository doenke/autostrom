{% extends "layout.html" %}
{% block content %}

{% if error_msg %}
  <div style="padding:0.8rem 1rem; border:1px solid #f5c2c7; background:#fde2e4; color:#7a1520; border-radius:8px; margin-bottom:1rem;">
    <strong>Fehler beim Laden der Daten:</strong><br>
    <code>{{ error_msg }}</code>
  </div>
{% endif %}

<h2>Neue Ablesung</h2>
<p class="muted">
  {% if last %}
    Letzte Ablesung: <strong>{{ last.Datum }}</strong> – Zählerstand:
    <strong>{{ last.Zaehlerstand }} kWh</strong> – Strompreis:
    <strong>{{ '%.4f'|format(last.Strompreis) }} €/kWh</strong>
  {% else %}
    Noch keine Daten vorhanden.
  {% endif %}
</p>

<form method="post" action="/submit" class="card" style="margin-top:1rem;">
  <label>Ablesedatum
    <!-- heute vorbefüllen -->
    <input type="date" name="ablesedatum" value="{{ today_iso }}" required>
  </label>

  <label>Aktueller Zählerstand (kWh)
    <input type="number" step="1" name="zaehlerstand" placeholder="z. B. 12345" required>
  </label>

  <label>Strompreis (€/kWh)
    <!-- letzten Preis vorbefüllen, falls bekannt -->
    <input type="number" step="0.0001" name="strompreis_eur" value="{{ last_price }}" placeholder="z. B. 0.3200" required>
  </label>

  <label class="checkbox">
    <input type="checkbox" name="send_mail" checked>
    PDF per E-Mail senden
  </label>

  <label class="checkbox">
    <input type="checkbox" name="upload_paperless">
    PDF zu Paperless-ngx hochladen
  </label>

  <button type="submit">Abrechnung erstellen</button>
</form>

{% if rows and rows|length > 0 %}
  <section style="margin-top:2rem;">
    <h2>Letzte Einträge</h2>
    <div style="overflow:auto;">
      <table class="medplan">
        <thead>
          <tr>
            <th>Datum</th>
            <th>Zählerstand</th>
            <th>Verbrauch</th>
            <th>Strompreis</th>
            <th>Abrechnung</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rows %}
            <tr>
              <td>{{ r.Datum }}</td>
              <td>{{ r.Zaehlerstand }} kWh</td>
              <td>{{ r.Verbrauch }} kWh</td>
              <td>{{ '%.4f'|format(r.Strompreis|float) }} €</td>
              <td>{{ '%.2f'|format(r.Abrechnung|float) }} €</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
{% endif %}

{% endblock %}
