{% extends "layout.html" %}
{% block content %}

{% if form_values is not defined %}
  {% set form_values = {} %}
{% endif %}

{% if error_msg %}
  <div class="alert alert-error">
    <strong>Fehler beim Laden der Daten:</strong><br>
    <code>{{ error_msg }}</code>
  </div>
{% endif %}

{% if info_msg and not error_msg %}
  <div class="alert alert-info">
    {{ info_msg }}
  </div>
{% endif %}

<h2>Neue Ablesung</h2>
<p class="muted">
  {% if last %}
    Letzte Ablesung: <strong>{{ last.Datum }}</strong><br>
    Z√§hlerstand: <strong>{{ last.Zaehlerstand }} kWh</strong> Strompreis:
    <strong>{{ '%.4f'|format((last.Strompreis|string).replace(',', '.')|float) }} ‚Ç¨/kWh</strong>
  {% else %}
    Noch keine Daten vorhanden.
  {% endif %}
</p>

<form method="post" action="/submit" class="card form-new-reading">
  <!-- If you use CSRF protection, include the token here -->

  <label for="ablesedatum">Ablesedatum</label>
  <input
    type="date"
    id="ablesedatum"
    name="ablesedatum"
    value="{{ form_values.ablesedatum or today_iso }}"
    required
  >

  <label for="zaehlerstand">Aktueller Z√§hlerstand (kWh)</label>
  <input
    type="number"
    step="1"
    id="zaehlerstand"
    name="zaehlerstand"
    placeholder="z. B. 12345"
    value="{{ form_values.zaehlerstand or '' }}"
    required
  >
  <small class="muted">
    Hinweis: Der Verbrauch zwischen zwei Ablesungen muss zwischen 10 und 2000 kWh liegen.
  </small>

  <label for="strompreis_eur">Strompreis (‚Ç¨/kWh)</label>
  <input
    type="number"
    step="0.0001"
    id="strompreis_eur"
    name="strompreis_eur"
    value="{{ form_values.strompreis_eur or last_price }}"
    placeholder="z. B. 0.3200"
    required
  >

  {% if mail_available %}
    <label class="checkbox" for="send_mail">
      <input
        type="checkbox"
        id="send_mail"
        name="send_mail"
        {% if default_mail_checked %}checked{% endif %}
      >
      PDF per E-Mail senden
    </label>
  {% endif %}

  {% if paperless_available %}
    <label class="checkbox" for="upload_paperless">
      <input
        type="checkbox"
        id="upload_paperless"
        name="upload_paperless"
        {% if default_paperless_checked %}checked{% endif %}
      >
      PDF zu Paperless-ngx hochladen
    </label>
  {% endif %}

  <button type="submit">Abrechnung erstellen</button>
</form>

{% if rows and rows|length > 0 %}
  <section class="section-entries">
    <h2>Letzte Eintr√§ge</h2>

    <div class="table-wrapper">
      <table class="medplan">
        <thead>
          <tr>
            <th>Datum</th>
            <th>Z√§hlerstand</th>
            <th>Verbrauch</th>
            <th>Strompreis</th>
            <th>Abrechnung</th>
            {% if show_delete_button %}
              <th class="actions-col">Aktion</th>
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% for r in rows %}
            <tr>
              <td>{{ r.Datum }}</td>
              <td>{{ r.Zaehlerstand }} kWh</td>
              <td>{{ r.Verbrauch }} kWh</td>
              <td>{{ '%.4f'|format((r.Strompreis|string).replace(',', '.')|float) }} ‚Ç¨</td>
              <td>{{ '%.2f'|format((r.Abrechnung|string).replace(',', '.')|float) }} ‚Ç¨</td>
              {% if show_delete_button %}
                <td class="actions">
                  {% if loop.first %}
                    <form action="/delete-last" method="post" class="delete-form">
                      <!-- If you use CSRF protection, include the token here -->
                      <button
                        type="submit"
                        class="trash-button"
                        aria-label="Letzte Zeile aus CSV l√∂schen"
                      >
                        üóëÔ∏è
                      </button>
                    </form>
                  {% endif %}
                </td>
              {% endif %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
{% endif %}

{% endblock %}
