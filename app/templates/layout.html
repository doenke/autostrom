<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Autostrom Abrechnung</title>
    <link rel="stylesheet" href="{{ url_for('static', path='style.css') }}" />
  </head>
  <body>
    <header>
      <span class="name">Autostrom</span>
      <h1>Abrechnung &amp; Upload</h1>
    </header>

    <main>
      {% block content %}{% endblock %}
    </main>

    <footer>
      Autostrom &ndash; Nextcloud CSV Abrechnung
    </footer>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        var deleteForm = document.querySelector('.delete-form');
        if (deleteForm) {
          deleteForm.addEventListener('submit', function (event) {
            if (!confirm('Willst du wirklich den letzten Eintrag löschen?')) {
              event.preventDefault();
            }
          });
        }

        setupLocalizedDateInput();
      });

      function setupLocalizedDateInput() {
        var hiddenInput = document.getElementById('ablesedatum');
        var displayInput = document.getElementById('ablesedatum_display');
        if (!hiddenInput || !displayInput) {
          return;
        }

        var locale = navigator.language || navigator.userLanguage || 'de-DE';
        var formatter;
        try {
          formatter = new Intl.DateTimeFormat(locale);
        } catch (err) {
          formatter = new Intl.DateTimeFormat('de-DE');
        }

        var defaultIso = displayInput.dataset.defaultIso || hiddenInput.value;
        if (defaultIso && hiddenInput.value !== defaultIso) {
          hiddenInput.value = defaultIso;
        }
        var exampleDate = new Date(Date.UTC(2024, 0, 15));
        displayInput.placeholder = formatter.format(exampleDate);

        function pad(value) {
          return String(value).padStart(2, '0');
        }

        function dateToIso(dateObj) {
          return [
            dateObj.getUTCFullYear(),
            pad(dateObj.getUTCMonth() + 1),
            pad(dateObj.getUTCDate()),
          ].join('-');
        }

        function isoToDate(isoString) {
          if (!isoString) {
            return null;
          }
          var parts = isoString.split('-');
          if (parts.length !== 3) {
            return null;
          }
          var year = parseInt(parts[0], 10);
          var month = parseInt(parts[1], 10) - 1;
          var day = parseInt(parts[2], 10);
          if (isNaN(year) || isNaN(month) || isNaN(day)) {
            return null;
          }
          return new Date(Date.UTC(year, month, day));
        }

        function parseDisplayValue(value) {
          var trimmed = value.trim();
          if (!trimmed) {
            return null;
          }

          var isoMatch = trimmed.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
          if (isoMatch) {
            return new Date(
              Date.UTC(
                parseInt(isoMatch[1], 10),
                parseInt(isoMatch[2], 10) - 1,
                parseInt(isoMatch[3], 10)
              )
            );
          }

          var deMatch = trimmed.match(/^(\d{1,2})[.\/-](\d{1,2})[.\/-](\d{2,4})$/);
          if (deMatch) {
            var year = parseInt(deMatch[3], 10);
            if (year < 100) {
              year += 2000;
            }
            return new Date(
              Date.UTC(
                year,
                parseInt(deMatch[2], 10) - 1,
                parseInt(deMatch[1], 10)
              )
            );
          }

          var fallback = Date.parse(trimmed);
          if (!Number.isNaN(fallback)) {
            var parsed = new Date(fallback);
            return new Date(
              Date.UTC(
                parsed.getFullYear(),
                parsed.getMonth(),
                parsed.getDate()
              )
            );
          }

          return null;
        }

        function syncDisplayWithHidden() {
          var isoValue = hiddenInput.value;
          var dateObj = isoToDate(isoValue);
          if (!dateObj) {
            displayInput.value = '';
            return;
          }
          displayInput.value = formatter.format(dateObj);
        }

        function syncHiddenWithDisplay() {
          var dateObj = parseDisplayValue(displayInput.value);
          if (!dateObj) {
            displayInput.setCustomValidity('Bitte ein gültiges Datum eingeben.');
            return false;
          }
          displayInput.setCustomValidity('');
          hiddenInput.value = dateToIso(dateObj);
          displayInput.value = formatter.format(dateObj);
          return true;
        }

        syncDisplayWithHidden();

        displayInput.addEventListener('blur', syncHiddenWithDisplay);
        displayInput.addEventListener('change', syncHiddenWithDisplay);
        displayInput.addEventListener('input', function () {
          displayInput.setCustomValidity('');
        });

        var form = displayInput.form;
        if (form) {
          form.addEventListener('submit', function (event) {
            if (!syncHiddenWithDisplay()) {
              event.preventDefault();
              displayInput.reportValidity();
            }
          });
        }
      }
    </script>
  </body>
</html>
